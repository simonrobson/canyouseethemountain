<!DOCTYPE html>
<html>
	<head>
		<title>Can You See The Mountain: Doi Suthep</title>

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<link rel="stylesheet" href="leaflet/leaflet.css" />
		<link rel="stylesheet" href="style.css" />

		<link rel="icon" href="/favicon.ico" type="image/x-icon">
	</head>
	<body class="locale-th">

		<div id="title-project">
			<h1>Can you see the mountain?<span>Doi Suthep</span></h1>
		</div>

		<div id="map"></div>

		<div class="splash">
			<img class="geo-spinner" src="/images/Preloader_1	.gif"/>
			<p>กำลังค้นหาตำแหน่งของคุณ</p>
		</div>

		<div class="location-error hide">



			<h1>ไม่สามารถระบุตำแหน่งของคุณได้</h1>
			<p>กรุณา Refresh หน้าเว็บไซต์อีกครั้ง</p>
		</div>

		<div class="content hide">
			<h1 class="question">วันนี้คุณมองเห็นดอยสุเทพไหม?</h1>

			<div class="buttons">
				<button type="button" class="btn btn-clear" onclick="sendVisibility(100)">
					ชัดเจน
				</button>

				<button type="button" class="btn btn-hazy" onclick="sendVisibility(50)">
					เห็นบ้าง
				</button>

				<button type="button" class="btn btn-terrible" onclick="sendVisibility(0)">
					ไม่เลย
				</button>
			</div>
		</div>

		<div class="response hide">
			<p>ขอบคุณสำหรับข้อมูลค่ะ</p>
		</div>

		<script src="js/lib.js"></script>

		<script>
			var map = L.map('map');
			var ajax = require('ajax');
			var coords = {};

			L.Icon.Default.imagePath = '/leaflet/images';

			L.tileLayer('http://{s}.mqcdn.com/tiles/1.0.0/map/{z}/{x}/{y}.jpg ', {
				subdomains: ['otile1', 'otile2', 'otile3', 'otile4'],
				maxZoom: 16,
				attribution: '<a href="">MapQuest</a>, <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> and contributors, <a href="http://wiki.openstreetmap.org/wiki/Legal_FAQ#I_would_like_to_use_OpenStreetMap_maps._How_should_I_credit_you">ODbL</a>.'
			}).addTo(map);

			function sendVisibility(visibility){
				ajax({
					type: 'POST',
					url: '/checkins',
					dataType: 'json',
					data: {
						checkin: {
							coords: coords,
							timezone: (new Date().getTimezoneOffset() / 60) * -1,
							landmark_id: 1,
							visibility: visibility
						}
					},
					success: function(response) {
						L.geoJson(response.visibility_layer, {style: styleFeature}).addTo(map);
						document.querySelector('.content').classList.add('hide');
						document.querySelector('.response').classList.remove('hide');
						document.querySelector('#map').classList.add('response-state');
						map.invalidateSize();
						map.setZoom(12);
					},
					error: function() {
						alert( "Error submitting your results" );
					},
				});
			}

			function styleFeature(feature) {
				return {
					weight: 0,
					opacity: 0,
					fillColor: 'hsla(' + feature.properties.visibility + ', 70%, 40%, '+ feature.properties.accuracy +')',
					fillOpacity: 0.4
				};
			}

			navigator.geolocation.getCurrentPosition(function(pos) {
				var latLng = L.latLng(pos.coords.latitude, pos.coords.longitude);
				coords = pos.coords;
				map.setView(latLng, 14);
				L.marker(latLng).addTo(map);
				L.circle(latLng, coords.accuracy / 2).addTo(map);
				document.querySelector('.splash').classList.add('hide');
				document.querySelector('.content').classList.remove('hide');
				map.panBy([0, adjustedLat()]);
			},
			function(errors) {
				document.querySelector('body').classList.add('no-location');
				document.querySelector('.splash').classList.add('hide');
				document.querySelector('.location-error').classList.remove('hide');
				document.querySelector('#map').classList.add('hide');
			});

			function adjustedLat() {
				var mapHeight = document.querySelector('#map').clientHeight;
				var contentHeight = document.querySelector('.content').clientHeight - 60 //padding;
				return (mapHeight / 2) - ((mapHeight - contentHeight) / 2);
			}
		</script>
	</body>
</html>
